rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isLoggedIn() {
      return request.auth != null;
    }
  
    function isOwnerBefore() {
      return request.auth.uid == resource.data.createdBy || resource == null;
    }

    function isOwnerAfter() {
      return request.auth.uid == request.resource.data.createdBy || request.resource == null;
    }
    
    function isCreateTime() {
      return request.time == request.resource.data.createdAt;
    }
    
    function isUpdateTime() {
      return request.time == request.resource.data.updatedAt
        && request.resource.data.createdAt == resource.data.createdAt;
    }

    match /posts/{postId} {
    
    	function isNonEmptyContent() {
        return request.resource.data.content is string
          && request.resource.data.content.size() > 1;
      }
    
      allow create: if isLoggedIn()
        && isNonEmptyContent()
        && isOwnerAfter()
        && isCreateTime();
        
      allow update: if isLoggedIn()
        && isNonEmptyContent()
        && isOwnerBefore()
        && isOwnerAfter()
        && isUpdateTime();
        
      allow delete: if isLoggedIn()
        && isOwnerBefore();

      allow read: if true;
    }

    match /usernames/{username} {
      allow read: if true;
    }

    match /users/{userId} {

      function isOwnerID() {
        return request.auth.uid == request.resource.id;
      }

      allow read: if true;

      allow create: if isLoggedIn()
        && isOwnerID()
        && isCreateTime();
        
      allow update: if isLoggedIn()
        && isOwnerID()
        && isUpdateTime();
        
      allow delete: if isLoggedIn()
        && isOwnerBefore();
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}